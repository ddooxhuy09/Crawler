import{c as b,P as u,b as h,e as y,a as E,d as D,f as P}from"./chunk-c587a301.js";var k=(e="")=>{const c=b();let n,t=[];const o=E(),r=new Set,a=new Set,g=(s,p)=>{switch(s.status){case"undeliverable":t.some(i=>i.message.messageID===s.message.messageID)||(t=[...t,{message:s.message,resolvedDestination:s.resolvedDestination}]);return;case"deliverable":t=t.reduce((i,d)=>d.resolvedDestination===s.deliverableTo?(u.toBackground(p,{type:"deliver",message:d.message}),i):[...i,d],[]);return;case"delivered":s.receipt.message.messageType==="message"&&o.add(s.receipt);return;case"incoming":s.message.messageType==="reply"&&o.remove(s.message.messageID),r.forEach(i=>i(s.message,p));return;case"terminated":{const i=o.entries().filter(d=>s.fingerprint===d.to);o.remove(i),i.forEach(({message:d})=>a.forEach(M=>M(d)))}}},w=()=>{n=h.runtime.connect({name:y({endpointName:e,fingerprint:c})}),n.onMessage.addListener(g),n.onDisconnect.addListener(w),u.toBackground(n,{type:"sync",pendingResponses:o.entries(),pendingDeliveries:[...new Set(t.map(({resolvedDestination:s})=>s))]})};return w(),{onFailure(s){a.add(s)},onMessage(s){r.add(s)},postMessage(s){u.toBackground(n,{type:"deliver",message:s})}}},m,L=(e,c,n)=>m??(m=new Promise(t=>{const o=a=>{const{data:{cmd:g,scope:w,context:s},ports:p}=a;if(g==="webext-port-offer"&&w===c&&s!==e)return window.removeEventListener("message",o),p[0].onmessage=n,p[0].postMessage("port-accepted"),t(p[0])},r=()=>{const a=new MessageChannel;a.port1.onmessage=g=>{if(g.data==="port-accepted")return window.removeEventListener("message",o),t(a.port1);n?.(g)},window.postMessage({cmd:"webext-port-offer",scope:c,context:e},"*",[a.port2])};window.addEventListener("message",o),e==="window"?setTimeout(r,0):r()})),x=e=>{let c,n=!1,t,o;return{enable:()=>n=!0,onMessage:r=>t=r,postMessage:async r=>{if(e!=="content-script"&&e!=="window")throw new Error("Endpoint does not use postMessage");if(!n)throw new Error("Communication with window has not been allowed");return I(c),(await o).postMessage(r)},setNamespace:r=>{if(c)throw new Error("Namespace once set cannot be changed");c=r,o=L(e,r,({data:a})=>t?.(a))}}};function I(e){if(typeof e!="string"||e.trim().length===0)throw new Error(`webext-bridge uses window.postMessage to talk with other "window"(s) for message routingwhich is global/conflicting operation in case there are other scripts using webext-bridge. Call Bridge#setNamespace(nsps) to isolate your app. Example: setNamespace('com.facebook.react-devtools'). Make sure to use same namespace across all your scripts whereever window.postMessage is likely to be used\``)}var f=x("content-script"),v=k(),l=D("content-script",e=>{e.destination.context==="window"?f.postMessage(e):v.postMessage(e)});f.onMessage(e=>{e.origin={context:"window",tabId:null},l.handleMessage(e)});v.onMessage(l.handleMessage);v.onFailure(e=>{if(e.origin.context==="window"){f.postMessage({type:"error",transactionID:e.transactionId});return}l.endTransaction(e.transactionId)});var{sendMessage:S,onMessage:T}=l;P(l);export{S as s};
