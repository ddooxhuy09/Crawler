import{c as P,d as C,b as A,g as S,h as v,p as R,f as U,a as G,P as h,_ as g,i as Y,q as N}from"./chunk-c587a301.js";import{s as y,g as M,u as H,t as L,a as T,b as k,c as x,d as F,e as B,f as $}from"./chunk-db484706.js";import{R as V,Q as E}from"./chunk-15a82b54.js";var b=G(),c=new Map,_=new Map,w=new Map,O=(e,n)=>(_.set(e,(_.get(e)||new Set).add(n)),()=>{const t=_.get(e);t?.delete(n)&&t?.size===0&&_.delete(e)}),D=(e,n)=>{w.set(e,(w.get(e)||new Set).add(n))},f=e=>({withFingerprint:n=>{const t=i=>({and:()=>i}),a={aboutIncomingMessage:i=>{const r=c.get(e);return h.toExtensionContext(r.port,{status:"incoming",message:i}),t(a)},aboutSuccessfulDelivery:i=>{const r=c.get(e);return h.toExtensionContext(r.port,{status:"delivered",receipt:i}),t(a)},aboutMessageUndeliverability:(i,r)=>{const o=c.get(e);return o?.fingerprint===n&&h.toExtensionContext(o.port,{status:"undeliverable",resolvedDestination:i,message:r}),t(a)},whenDeliverableTo:i=>{const r=()=>{const o=c.get(e);if(o?.fingerprint===n&&c.has(i))return h.toExtensionContext(o.port,{status:"deliverable",deliverableTo:i}),!0};if(!r()){const o=O(i,r);D(n,o)}return t(a)},aboutSessionEnded:i=>{const r=c.get(e);return r?.fingerprint===n&&h.toExtensionContext(r.port,{status:"terminated",fingerprint:i}),t(a)}};return a}}),j=P(),m=C("background",e=>{var n;if(e.origin.context==="background"&&["content-script","devtools "].includes(e.destination.context)&&!e.destination.tabId)throw new TypeError("When sending messages from background page, use @tabId syntax to target specific tab");const t=v(g(g({},e.origin),e.origin.context==="window"&&{context:"content-script"})),a=v(Y(g(g({},e.destination),e.destination.context==="window"&&{context:"content-script"}),{tabId:e.destination.tabId||e.origin.tabId}));e.destination.tabId=null,e.destination.frameId=null;const i=()=>c.get(a),r=()=>c.get(t),o=()=>{var s;f(a).withFingerprint(i().fingerprint).aboutIncomingMessage(e);const p={message:e,to:i().fingerprint,from:{endpointId:t,fingerprint:(s=r())==null?void 0:s.fingerprint}};e.messageType==="message"&&b.add(p),e.messageType==="reply"&&b.remove(e.messageID),r()&&f(t).withFingerprint(r().fingerprint).aboutSuccessfulDelivery(p)};(n=i())!=null&&n.port?o():e.messageType==="message"&&(e.origin.context==="background"?O(a,o):r()&&f(t).withFingerprint(r().fingerprint).aboutMessageUndeliverability(a,e).and().whenDeliverableTo(a))},e=>{const n=v(g(g({},e.origin),e.origin.context==="window"&&{context:"content-script"})),t=c.get(n),a={message:e,to:j,from:{endpointId:n,fingerprint:t.fingerprint}};f(n).withFingerprint(t.fingerprint).aboutSuccessfulDelivery(a)});A.runtime.onConnect.addListener(e=>{var n;const t=S(e.name);if(!t)return;t.endpointName||(t.endpointName=v({context:"content-script",tabId:e.sender.tab.id,frameId:e.sender.frameId}));const{tabId:a,frameId:i}=R(t.endpointName);c.set(t.endpointName,{fingerprint:t.fingerprint,port:e}),(n=_.get(t.endpointName))==null||n.forEach(r=>r()),_.delete(t.endpointName),D(t.fingerprint,()=>{const r=b.entries().filter(o=>o.to===t.fingerprint);b.remove(r),r.forEach(o=>{o.from.endpointId==="background"?m.endTransaction(o.message.transactionId):f(o.from.endpointId).withFingerprint(o.from.fingerprint).aboutSessionEnded(t.fingerprint)})}),e.onDisconnect.addListener(()=>{var r,o;((r=c.get(t.endpointName))==null?void 0:r.fingerprint)===t.fingerprint&&c.delete(t.endpointName),(o=w.get(t.fingerprint))==null||o.forEach(s=>s()),w.delete(t.fingerprint)}),e.onMessage.addListener(r=>{var o,s;if(r.type==="sync"){const p=[...c.values()].map(d=>d.fingerprint),u=r.pendingResponses.filter(d=>p.includes(d.to));b.add(...u),r.pendingResponses.filter(d=>!p.includes(d.to)).forEach(d=>f(t.endpointName).withFingerprint(t.fingerprint).aboutSessionEnded(d.to)),r.pendingDeliveries.forEach(d=>f(t.endpointName).withFingerprint(t.fingerprint).whenDeliverableTo(d));return}r.type==="deliver"&&((s=(o=r.message)==null?void 0:o.origin)==null?void 0:s.context)&&(r.message.origin.tabId=a,r.message.origin.frameId=i,m.handleMessage(r.message))})});var{sendMessage:J,onMessage:l}=m;U(m);async function I(){try{return await new Promise(n=>{chrome.storage.local.get([E],function(t){n(t[E])})})===!0}catch{return!1}}chrome.runtime.onInstalled.addListener(function(e){let n="https://sortpin.com/how-to-install-pinterest-sorting-extension";e.reason===chrome.runtime.OnInstalledReason.INSTALL&&chrome.tabs.create({url:n},function(t){console.log("New tab launched with "+n)})});chrome.runtime.setUninstallURL("https://sortpin.com/uninstall-extension");l("get-leads-count",async()=>{try{return await y.getTotals([],"","lead")}catch{return 0}});l("get-pin",async({data:e})=>{try{const{pinId:n}=e;return await M(n)}catch{return null}});l("store-pin",async({data:e})=>{try{const{pinData:n}=e;return await I()?(await H(V(n)),!0):!1}catch{return!1}});l("toggle-bookmark-pin",async({data:e})=>{try{const{pinId:n}=e,t=await L(n);return t||null}catch{return null}});l("get-board",async({data:e})=>{try{const{boardId:n}=e;return await T(n)}catch{return null}});l("store-board",async({data:e})=>{try{const{board:a}=e;if(!await I())return!1;const r=await new Promise((s,p)=>{chrome.storage.local.get(["YTUONG_APP_VERSION","YTUONG_HANDLER_ID","YTUONG_EXPERIMENT_HASH","YTUONG_PATH","YTUONG_ORIGIN"],function(u){s(u)})});var n=a?.url?.split("/")[1],t=a?.url?.split("/")[2];t=decodeURIComponent(t);const o=await T(a?.id);if(!o||!o?.updatedAt||Date.now()-o?.updatedAt>3600*1e3){const s={options:{username:n,slug:t,field_set_key:"detailed",no_fetch_context_on_resource:!1},context:{}},p={source_url:`/${n}/${t}/`,data:JSON.stringify(s),_:Math.floor(Date.now())};fetch(`${r.YTUONG_ORIGIN}/resource/BoardResource/get/?${N.stringify(p)}`,{headers:{"x-app-version":r.YTUONG_APP_VERSION,"x-pinterest-appstate":"active","x-pinterest-experimenthash":r.YTUONG_EXPERIMENT_HASH,"x-pinterest-source-url":r.YTUONG_PATH,"x-pinterest-pws-handler":r.YTUONG_HANDLER_ID}}).then(u=>u.json()).then(u=>(k(u.resource_response.data),Promise.resolve(u.resource_response.data)))}return!0}catch{return!1}});l("get-pinner",async({data:e})=>{try{const{pinnerId:n}=e;return await x(n)}catch{return null}});l("store-pinner",async({data:e})=>{try{const{pinner:n}=e;if(!await I())return!1;const a=await new Promise((r,o)=>{chrome.storage.local.get(["YTUONG_APP_VERSION","YTUONG_HANDLER_ID","YTUONG_EXPERIMENT_HASH","YTUONG_PATH","YTUONG_ORIGIN"],function(s){r(s)})}),i=await x(n?.id);if(!i||!i?.updatedAt||Date.now()-i?.updatedAt>3600*1e3){const r={options:{username:n?.username,field_set_key:"profile",no_fetch_context_on_resource:!1},context:{}},o={source_url:a.YTUONG_PATH,data:JSON.stringify(r),_:Math.floor(Date.now())};fetch(`${a.YTUONG_ORIGIN}/resource/UserResource/get/?${N.stringify(o)}`,{headers:{"x-app-version":a.YTUONG_APP_VERSION,"x-pinterest-appstate":"active","x-pinterest-experimenthash":a.YTUONG_EXPERIMENT_HASH,"x-pinterest-source-url":a.YTUONG_PATH,"x-pinterest-pws-handler":a.YTUONG_HANDLER_ID}}).then(s=>s.json()).then(s=>(F(s.resource_response.data),Promise.resolve(s.resource_response.data)))}return!0}catch{return!1}});l("CLEANUP_DATA",async()=>{try{return await B.cleanDataOlderThan7Days(),await $.cleanDataOlderThan7Days(),await y.cleanDataOlderThan7Days(),console.log("Cleanup data successfully"),!0}catch(e){return console.log("Cleanup data failed",e),!1}});
